<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ejemplo - Servicio de Cotizaciones</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .panel h2 {
            color: #333;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button.secondary {
            background: #6c757d;
        }

        button.danger {
            background: #dc3545;
        }

        button.success {
            background: #28a745;
        }

        .output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            min-height: 100px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #667eea;
            padding-left: 10px;
        }

        .log-entry.success {
            border-left-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }

        .log-entry.error {
            border-left-color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        .log-entry.info {
            border-left-color: #17a2b8;
            background: rgba(23, 162, 184, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .comparison-item {
            padding: 15px;
            border-radius: 8px;
        }

        .comparison-item.before {
            background: rgba(220, 53, 69, 0.1);
            border: 2px solid #dc3545;
        }

        .comparison-item.after {
            background: rgba(40, 167, 69, 0.1);
            border: 2px solid #28a745;
        }

        .comparison-item h3 {
            margin-bottom: 10px;
        }

        pre {
            background: #2d3748;
            color: #68d391;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üí± Ejemplo - Servicio de Cotizaciones</h1>
            <p>Demostraci√≥n del servicio modular con cach√© inteligente</p>
        </header>

        <!-- Panel de Pruebas -->
        <div class="panel">
            <h2>üß™ Pruebas de Funciones</h2>
            <div class="button-grid">
                <button onclick="testGetExchangeRates()">üåê Obtener Tasas USD</button>
                <button onclick="testGetSpecificRate()">üîÑ USD ‚Üí CLP</button>
                <button onclick="testMultipleRates()">üìä M√∫ltiples Tasas</button>
                <button onclick="testConvertCurrency()">üí∞ Convertir 100 USD</button>
                <button onclick="testVariation()">üìà Calcular Variaci√≥n</button>
                <button onclick="testPreload()">üöÄ Precargar Monedas</button>
            </div>
            <div class="output" id="testOutput">
                <div class="log-entry info">üëã Haz clic en los botones para probar las funciones</div>
            </div>
        </div>

        <!-- Panel de Cach√© -->
        <div class="panel">
            <h2>üíæ Estado del Cach√©</h2>
            <div class="button-grid">
                <button class="success" onclick="showCacheInfo()">üîç Ver Info de Cach√©</button>
                <button class="secondary" onclick="showCacheStats()">üìä Estad√≠sticas</button>
                <button class="danger" onclick="testClearCache()">üóëÔ∏è Limpiar Cach√©</button>
                <button class="secondary" onclick="testHasCachedData()">‚úÖ Verificar USD</button>
            </div>
            <div class="output" id="cacheOutput">
                <div class="log-entry info">üíæ El cach√© se actualiza autom√°ticamente cada 5 minutos</div>
            </div>
        </div>

        <!-- Comparaci√≥n Antes/Despu√©s -->
        <div class="panel">
            <h2>üîÑ Comparaci√≥n: Antes vs Despu√©s</h2>
            <div class="comparison">
                <div class="comparison-item before">
                    <h3>‚ùå ANTES (Sin Cach√©)</h3>
                    <pre>async function getData() {
  // Llamada directa cada vez
  const res = await fetch(
    'https://api.exchangerate-api.com/v4/latest/USD'
  );
  const data = await res.json();
  return data.rates;
}

// Problema:
// - Llamada API cada vez
// - Sin optimizaci√≥n
// - Lento y costoso</pre>
                </div>
                <div class="comparison-item after">
                    <h3>‚úÖ DESPU√âS (Con Cach√©)</h3>
                    <pre>import { getExchangeRates } 
  from './exchangeRateService.js';

async function getData() {
  // Cach√© autom√°tico
  const rates = await getExchangeRates('USD');
  return rates;
}

// Beneficios:
// - Cach√© de 5 minutos
// - Fallback inteligente
// - R√°pido y eficiente</pre>
                </div>
            </div>
        </div>

        <!-- Panel de Estad√≠sticas -->
        <div class="panel">
            <h2>üìà Estad√≠sticas de Rendimiento</h2>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-label">Llamadas API</div>
                    <div class="stat-value" id="apiCalls">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Hits de Cach√©</div>
                    <div class="stat-value" id="cacheHits">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ahorro %</div>
                    <div class="stat-value" id="savingsPercent">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Monedas en Cach√©</div>
                    <div class="stat-value" id="cachedCurrencies">0</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { 
            getExchangeRates, 
            getExchangeRate,
            getMultipleExchangeRates,
            convertCurrency,
            calculateVariation,
            clearCache,
            clearCacheForCurrency,
            getCacheInfo,
            getCacheStats,
            hasCachedData,
            preloadCurrencies
        } from './exchangeRateService.js';

        // Variables de tracking
        let apiCallsCount = 0;
        let cacheHitsCount = 0;

        // Funciones globales para los botones
        window.testGetExchangeRates = async function() {
            log('testOutput', 'üåê Obteniendo todas las tasas para USD...', 'info');
            try {
                const rates = await getExchangeRates('USD');
                log('testOutput', `‚úÖ Obtenidas ${Object.keys(rates).length} tasas`, 'success');
                log('testOutput', `Ejemplos: EUR=${rates.EUR}, GBP=${rates.GBP}, CLP=${rates.CLP}`, 'success');
                updateStats();
            } catch (error) {
                log('testOutput', `‚ùå Error: ${error.message}`, 'error');
            }
        };

        window.testGetSpecificRate = async function() {
            log('testOutput', 'üîÑ Obteniendo tasa USD ‚Üí CLP...', 'info');
            try {
                const rate = await getExchangeRate('USD', 'CLP');
                log('testOutput', `‚úÖ 1 USD = ${rate.toFixed(2)} CLP`, 'success');
                updateStats();
            } catch (error) {
                log('testOutput', `‚ùå Error: ${error.message}`, 'error');
            }
        };

        window.testMultipleRates = async function() {
            log('testOutput', 'üìä Obteniendo m√∫ltiples tasas...', 'info');
            try {
                const rates = await getMultipleExchangeRates('USD', ['EUR', 'GBP', 'CLP', 'CNY', 'BRL']);
                log('testOutput', `‚úÖ Obtenidas ${Object.keys(rates).length} tasas:`, 'success');
                Object.entries(rates).forEach(([currency, rate]) => {
                    log('testOutput', `  - ${currency}: ${rate}`, 'success');
                });
                updateStats();
            } catch (error) {
                log('testOutput', `‚ùå Error: ${error.message}`, 'error');
            }
        };

        window.testConvertCurrency = async function() {
            log('testOutput', 'üí∞ Convirtiendo 100 USD a CLP...', 'info');
            try {
                const converted = await convertCurrency(100, 'USD', 'CLP');
                log('testOutput', `‚úÖ 100 USD = ${converted.toFixed(2)} CLP`, 'success');
                updateStats();
            } catch (error) {
                log('testOutput', `‚ùå Error: ${error.message}`, 'error');
            }
        };

        window.testVariation = function() {
            log('testOutput', 'üìà Calculando variaci√≥n 950 ‚Üí 920...', 'info');
            const variation = calculateVariation(950, 920);
            log('testOutput', `‚úÖ Cambio: ${variation.change} (${variation.changePercent}%)`, 'success');
        };

        window.testPreload = async function() {
            log('testOutput', 'üöÄ Precargando monedas USD, EUR, GBP...', 'info');
            try {
                const results = await preloadCurrencies(['USD', 'EUR', 'GBP']);
                Object.entries(results).forEach(([currency, result]) => {
                    if (result.success) {
                        log('testOutput', `‚úÖ ${currency} precargado`, 'success');
                    } else {
                        log('testOutput', `‚ùå ${currency} fall√≥: ${result.error}`, 'error');
                    }
                });
                updateStats();
            } catch (error) {
                log('testOutput', `‚ùå Error: ${error.message}`, 'error');
            }
        };

        window.showCacheInfo = function() {
            log('cacheOutput', 'üîç Informaci√≥n detallada del cach√©:', 'info');
            const info = getCacheInfo();
            if (Object.keys(info).length === 0) {
                log('cacheOutput', '‚ö†Ô∏è No hay datos en cach√© a√∫n', 'info');
            } else {
                Object.entries(info).forEach(([currency, data]) => {
                    const status = data.valid ? '‚úÖ V√°lido' : '‚ùå Expirado';
                    log('cacheOutput', `${status} ${currency}: ${data.ageMinutes.toFixed(2)} min, ${data.ratesCount} tasas`, data.valid ? 'success' : 'error');
                });
            }
            updateStats();
        };

        window.showCacheStats = function() {
            log('cacheOutput', 'üìä Estad√≠sticas generales:', 'info');
            const stats = getCacheStats();
            log('cacheOutput', `Total monedas: ${stats.totalCurrencies}`, 'info');
            log('cacheOutput', `V√°lidas: ${stats.validCount}`, 'success');
            log('cacheOutput', `Expiradas: ${stats.expiredCount}`, stats.expiredCount > 0 ? 'error' : 'success');
            log('cacheOutput', `Total tasas: ${stats.totalRates}`, 'info');
            if (stats.totalCurrencies > 0) {
                log('cacheOutput', `M√°s antigua: ${stats.oldestAgeMinutes.toFixed(2)} min`, 'info');
                log('cacheOutput', `M√°s reciente: ${stats.newestAgeMinutes.toFixed(2)} min`, 'info');
            }
            updateStats();
        };

        window.testClearCache = function() {
            log('cacheOutput', 'üóëÔ∏è Limpiando cach√©...', 'info');
            clearCache();
            log('cacheOutput', '‚úÖ Cach√© limpiado completamente', 'success');
            updateStats();
        };

        window.testHasCachedData = function() {
            const hasCached = hasCachedData('USD');
            if (hasCached) {
                log('cacheOutput', '‚úÖ Hay datos v√°lidos de USD en cach√©', 'success');
            } else {
                log('cacheOutput', '‚ùå No hay datos v√°lidos de USD en cach√©', 'error');
            }
        };

        // Funciones de utilidad
        function log(outputId, message, type = 'info') {
            const output = document.getElementById(outputId);
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            output.appendChild(entry);
            output.scrollTop = output.scrollHeight;
        }

        function updateStats() {
            const stats = getCacheStats();
            document.getElementById('cachedCurrencies').textContent = stats.totalCurrencies;
            
            // Simular tracking de llamadas (en producci√≥n se har√≠a diferente)
            const totalRequests = stats.totalCurrencies;
            const savings = totalRequests > 0 ? ((stats.validCount / totalRequests) * 100).toFixed(0) : 0;
            
            document.getElementById('cacheHits').textContent = stats.validCount;
            document.getElementById('savingsPercent').textContent = savings + '%';
        }

        // Actualizar estad√≠sticas cada 5 segundos
        setInterval(updateStats, 5000);

        // Log inicial
        log('testOutput', '‚úÖ Servicio cargado y listo', 'success');
        log('cacheOutput', 'üíæ Sistema de cach√© activo (5 minutos)', 'success');
    </script>
</body>
</html>